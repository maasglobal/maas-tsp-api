openapi: 3.0.0
servers:
  - url: http://localhost:3000
    description: Local server
info:
  version: v1.1
  title: WhimApp TSP API
  ## NB: All Markdown paragraphs need to be 2 empty lines and all Markdown links must be resolved against repo root (not against this file path)
  ## Also x-logo must be resolved against repo root (not against this file path)
  ## Examples (externalValue) and $ref are resolved relative to this file path
  description: >-
    This is a API specification of REST endpoints that a Transport Service
    Provider (TSP) should implement to offer their services through the 
    [Whim application](https://whimapp.com/).


    It is written in machine readable 
    [OpenAPI Specification](https://github.com/OAI/OpenAPI-Specification) format, 
    so that API endpoints, validators and test clients can be generated from the
    documentation.

    ## Terminology

    * **endpoint** Publically resolvable URL either managed by MaaS Global (Whim Backend API) or by TSP (Booking API).

    * **booking** Information about single leg during the customer trip, together with customer information and state.§

    * **journey** Multi-leg journey which user plans via WhimApp. 

    * **leg** Single trip which is performed by TSP. Booking created and contain the state of this trip.

    * **TSP** Transport service provider. MaaS Global partner which offers their services via WhimApp.

    * **route** One of the possible journey. To determine it, we call TSP booking options endpoint to get available offers.

    * **WhimApp** Mobile application or similar which is used by Whim User to perform journeys. Collectively we treat all interaction from the point of WhimApp and user experience during the time user uses application.

    * **Whim backend** Caller of TSP API endpoints. WhimApp never calls TSP endpoints directly. All invocations are done from cloud-native infrastructure managed by MaaS Global.

    * **MaaS Global** MaaS Global is the world’s first true Mobility-as-a-Service (MaaS) operator with its award-winning Whim app, which provides users all city transport services in one app.

    ## Versions

    ### v1. Initial release (2018)

    **deprecated**
      
      * [OpenAPI Specification](specs/maas-v1.yml)
      * [Documentation](?maas-v1.yml)
      * [SwaggerUI](swagger-ui.html?urls.primaryName=maas-v1.yml)
      * Source code [repository](https://github.com/maasglobal/maas-tsp-api/tree/v1.0)

    ### v1.1 Latest version

    **under development**

      * [OpenAPI Specification](specs/booking.json)
      * [Documentation](?booking.json)
      * [SwaggerUI](swagger-ui.html?urls.primaryName=booking.yml)
      * Source code [repository](https://github.com/maasglobal/maas-tsp-api/)

    ## Running local server

    To run local server and execute API via [Swagger UI](swagger-ui.html?urls.primaryName=maas-v1.yml), follow the instruction in the [GitHub repo](https://github.com/maasglobal/maas-tsp-api/)

        git clone https://github.com/maasglobal/maas-tsp-api/
        cd maas-tsp-api
        npm install
        npm start

    Open your browser and navigate to http://localhost:3000

  termsOfService: 'https://github.com/maasglobal/maas-tsp-api/blob/master/terms.md'
  contact:
    name: Maas Global Team
    email: tech@maas-global.fi
    url: 'https://github.com/maasglobal/maas-tsp-api'
  license:
    name: MIT
    url: 'https://opensource.org/licenses/MIT'
  x-logo:
    url: 'assets/whim-logo.png'
    backgroundColor: '#FFFFFF'
    altText: 'Whim logo'
    href: 'https://whimapp.com'
tags:
  - name: Booking process
    description: >-
      The following scenario explains the life-cycle of an individual trip
      from a TSP viewpoint. Whenever a new concept (such as an actor or action)
      is represented, it is imprinted in **bold**.


      This scenario, with a few extra details is detailed in the process diagram
      below. It should be noted from the picture that MaaS more often acts as a
      caller than a callee for Transport Service Provider. 


      The cases of how WhimApp interacts with TSP are depicted in 
      [business process diagram](https://cawemo.com/embed/09a7739f-f8ce-4fe4-a5e5-a8f66ecedb8c)


      <html>
        <iframe src="https://cawemo.com/embed/acc4149c-8d04-4245-a047-c7dd94b97d88" 
          style="width: 100%; height:300px; border:1px solid #ccc" allowfullscreen="allowfullscreen">
        </iframe>
      <html>


      ## Planning a Route

      **User** **queries** for a **Route** with an address or latitude-logitude
      pair from one place to another. WhimApp queries the route from a third party
      **Routing Engine** that contains the data for **TSP** routes. At this point
      WhimApp makes no queries to the TSP - it expects the Routing Engine contains 
      valid GTFS data for the TSP.


      **WhimApp** shows several possible **Plans**, each containing a valid
      **Route** with several **Legs** with a part of a route using a specific
      TSP.


      ## Creating a Booking


      User browses through the Plans and chooses to book a trip. For each Leg
      in the Plan Route, WhimApp creates a new **Booking** by invoking corresponding endpoint in TSP.
      It should be noted that the booking may be hours or days in
      advance - a bit like in booking a hotel. The booking contains the
      individual Leg as the detailed travel plan for the TSP, as well as
      customer contact information.


      TSP receives the booking and confirms the trip. TSP may modify the details
      of the Booking, such as moving the **start location** to closest known
      street address or delaying the Leg **start time**, as long as the
      **end time** can be guaranteed. The Booking is supplemented with
      **booked** state information and additional **terms** latest such as
      the latest **cancellation time**.


      WhimApp checks that the booking succeeded and stores the Booking for future
      reference.


      ## Navigating a Route

      User starts to navigate the Route. WhimApp tracks for the user location to
      know if there are any changes needed in the plan. WhimApp triggers the changes
      for bookings by monitoring the individual Legs.


      WhimApp monitors the Booking terms and Leg **start time**.
      When the actual Leg starts, WhimApp **starts** the Leg and notifies the TSP.
      User or TSP may request changes to the Booking, e.g. in a case of a delay
      or cancellation.


      Each of these scenarios are described below.


      ## Updating a Booking


      A Booking may be updated by a User, WhimApp or TSP when any party receives
      new information that the Leg needs to be changed. Since the update may need
      confirmation from User or a 3rd party system, it is an asynchronous
      operation.


      Either party (WhimApp or TSP) may send an updated Booking with
      **UPDATE_REQUESTED** state. The recipient processes the request
      asynchronously and either confirms the request with **UPDATED** state,
      sends its proposal with **UPDATE_REQUESTED**, or cancels the leg with
      **CANCELLED** state.

      ## Cancelling a Booking


      A Booking may be cancelled by User or WhimApp within **cancellation time** in
      **terms** of the Booking without a specific request. WhimApp sends a modified
      Booking with state **CANCELLED** information. TSP confirms and updates its
      own systems.


      It should be noted that cancellation is an exception case and is likely
      happen only when the user chooses to cancel the whole route Plan.
      Instead, MaaS and/or TSP should update the booking with new information.

      TSP can assume Booking as paid if the cancellation time has passed and no
      cancellation has been received from MaaS.

      ## Paying a Booking

      A Booking may be paid (e.g. confirmed) before the **cancellation time**
      in **terms** has expired. WhimApp sends a modified Booking with **PAID**
      state wich the TSP confirms.

      TSP can assume Booking as paid if the cancellation time has passed and no
      cancellation has been received from WhimApp.


      ## Error Cases

      It may be possible that WhimApp sends an invalid request or the TSP cannot
      fulfill a request. In any such case, TSP may respond with an error. If
      TSP responds with an error, WhimApp assumes the state was not changed (e.g.
      a transaction was rolled back). WhimApp may repeat the request
      with the same or different data later on.


      The same principle applies when TSP is communicating with WhimApp.

    x-traitTag: true
  - name: User management
    description: >-
      The booking processes does not present separate user management process.

      All information about the WhimApp user are passed at the [Create booking](#operation/bookingCreate)
      invocation.

      During this invocation we also pass persistent user id together with user information (e-mail, phone, full-name).

      If required, user creation (or update) are managed at the TSP side transparently during the creation of booking.
    x-traitTag: true
  - name: KYC
    description: >-
      MaaS Global Oy performs due diligence
      when registering user. We check for example user to have a valid payment instrument (credit or debit card).


      If required, additional KYC process (for example, driver license check) can be performed before booking are created.


      This is out of scope of this APIs and to be defined in a separate aggreement.
    x-traitTag: true
  - name: Payment
    description: >-
      WhimApp offers two modes of operation for bookings which are created.

      ## Offline invoicing

      **Preferred** We are charging customer before the trip and will be invoiced by TSP according to the expenses for booking.

      Invoicing are handled via API (TBA) or via e-mail and expected to be processed every 1, 2 weeks or monthly.

      ## MaaS Global credit card

      Instead of specifying user credit card (we never do this!) we specify our credit card to be used by TSP for payment.
      This are not recommended
    x-traitTag: true
  - name: Booking
    description: >-
      Booking related APIs are the core of a TSP implementation.

      Correspondingly, a Booking is the main object exchanged between WhimApp and a
      TSP.
    x-traitTag: false
    x-displayName: Booking API
  - name: WebHook
    description: >-
      Publically available API which you can call to send booking state changes immediately when they
      happen, without the need to for us to poll our system by calling [Get booking](#operation/bookingGet) multiple times.


      This endpoinds are treated as Webhooks which you **may** call to make communication faster and booking process smoother.


      **WARNING**: The specific endpoing URL to be invoked are subject to change and aggreement between 
      TSP and MaaS Global.
    x-traitTag: false
    x-displayName: Whim Backend API
  - name: Support
    description: >-
      We would like to help you with code and other questions you might have.

      Search our documentation, contact support, or connect with our sales team.

      ### Improving documentation

      It would be great if you have anything to contribute to our documentation, 
      you can do it by creating a fork and issuing a pull-request.

      Or you can file an [issue](https://github.com/maasglobal/maas-tsp-api/issues) 
      if you discover some problem or invalid information.


      You also can reach team via tech@maas-global.fi
    x-traitTag: true
    x-displayName: Support
components:
  securitySchemes:
    apiKeyHeader:
      in: header
      name: X-API-Key
      type: apiKey
      description: >-
        Authorization scheme to use with TSP API should be based on specifying `X-API-Key`
        header when WhimApp makes request to the TSP API.


        Please not what due to serverless nature of our infrastructure we are unable to provide
        you with a set of IP addresses HTTP request will be originating from.


        To cope with that we propose using *optional* JSON payload signing, see here for more 
        information: https://developer.github.com/webhooks/securing/#validating-payloads-from-github
security:
  - apiKeyHeader: []
paths:
  /bookings/options:
    get:
      operationId: bookingOptionsGet
      summary: Available transport options
      description: >-
        Returns available transport options or offers.
        Start time can be defined, but is optional. If startTime is not provided, but
        required by the third party API, a default value of "Date.now()" is
        used.
      tags:
        - Booking
      parameters:
        - name: from
          description: "User's location in comma separated form e.g. 60.123,27.456"
          in: query
          required: true
          schema:
            $ref: ../schemas/core/components/units-geo.json#/definitions/shortLocationString
        - name: to
          description: 'A desired destination e.g. 60.123,27.456'
          in: query
          required: false
          schema:
            $ref: ../schemas/core/components/units-geo.json#/definitions/shortLocationString
      x-code-samples:
        - lang: Shell
          label: Query for taxi
          source: >-
            curl --location --request GET 'http://localhost:3000/bookings/options? \
              customer[clientId]=whim&customer[locale]=en& \
              customer[opaqueId]=deadbeef-deadbeef& \
              customer[phone]=+35840000000& \
              distance=9734&endTime=1572347575000& \
              from=60.1769789,24.9504135& \
              fromAddress=streetName:Siltasaarenkatu|streetNumber:1|city:Helsinki|zipCode:00530|country:Suomi&fromName=Siltasaarenkatu%201%20Helsinki& \
              mode=TAXI& \
              startTime=1572347575000& \
              to=60.23044350000001,24.8990183& \
              toAddress=streetName:Ida%20Aalbergin%20tie|streetNumber:3|city:Helsinki|zipCode:00400|country:Suomi& \
              toName=Ida%20Aalbergin%20tie%203%20Helsinki' \
                --header "x-api-key: pieY8Oezeicioyei5eisheeb7sheeLie"
      responses:
        '200':
          x-summary: Array of options
          description: >-
            Available transport methods matching the given query parameters. If
            no transport methods are available, an empty array is returned.
          content:
            application/json:
              schema:
                $ref: ../schemas/tsp/booking-options-list/response.json
              examples:
                Taxi:
                  summary: Taxi
                  externalValue: '../examples/taxi/booking-options-response.json'
  /bookings:
    post:
      operationId: bookingCreate
      summary: Create booking
      description: >-
        Creates a new `Booking` for the TSP in **booked** state. The returned
        object will be a refrence that is passed back & forth throughout the
        booking life cycle.

        The Booking may be modified in the response, e.g. location being
        adjusted for a more suitable pick-up location.

        In addition, the service may contain a **meta** attribute for arbitrary
        TSP metadata that the TSP needs later, and **token** attribute depicting
        how long the current state is valid.

        ### JSON Schema documentation

        Full schema documented here: 
        https://maasglobal.github.io/maas-schemas/docs/tsp/booking-create/request.html
      tags:
        - Booking
      requestBody:
        content:
          application/json:
            schema:
              $ref: ../schemas/tsp/booking-create/request.json
            examples:
              taxi:
                summary: Taxi
                externalValue: ../examples/taxi/booking-create-request.json
        description: >-
          Parameters of booking to be created, optionally referencing 
          offerId returned on the `/bookings/options` call.
        required: true
      responses:
        '200':
          x-summary: Booking
          description: >-
            Booking information
          content:
            application/json:
              schema:
                $ref: ../schemas/tsp/booking-create/response.json
              examples:
                Taxi:
                  summary: Taxi
                  externalValue: ../examples/taxi/booking-create-response.json
  /bookings/{tspId}:
    get:
      operationId: bookingGet
      summary: Get booking
      description: Returns the Booking that has been created earlier
      tags:
        - Booking
      parameters:
        - name: tspId
          description: ID of the booking created earlier
          in: path
          required: true
          schema:
            $ref: ../schemas/core/booking.json#/definitions/tspId
      responses:
        '200':
          description: The booking matching the query
          content:
            application/json:
              schema:
                $ref: ../schemas/core/booking.json
              examples:
                Taxi1:
                  summary: Taxi, reserved
                  externalValue: '../examples/taxi/booking-read-by-id-response.json'
                Taxi2:
                  summary: Taxi, activated
                  externalValue: '../examples/taxi/booking-read-by-id-response-activated.json'
        '400':
          description: Bad request (invalid query parameters)
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
        '401':
          description: Authorization error (invalid API key)
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
    patch:
      operationId: bookingUpdate
      summary: Update booking
      description: >-
        Update booking, chaning state or changing booking details.
      tags:
        - Booking
      parameters:
        - name: tspId
          description: ID of the booking created earlier
          in: path
          required: true
          schema:
            $ref: ../schemas/core/booking.json#/definitions/tspId
      responses:
        '200':
          description: Updated, old booking returned
          content:
            application/json:
              schema:
                $ref: ../schemas/core/booking.json
        '204':
          description: Updated, no content returned
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
        '401':
          description: Authorization error (invalid API key)
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
    delete:
      operationId: bookingDelete
      summary: Delete booking
      description: Deletes booking if it is possible
      tags:
        - Booking
      parameters:
        - name: tspId
          description: ID of the booking created earlier
          in: path
          required: true
          schema:
            $ref: ../schemas/core/booking.json#/definitions/tspId
      responses:
        '200':
          description: Deleted, old booking returned
          content:
            application/json:
              schema:
                $ref: ../schemas/core/booking.json
        '204':
          description: Deleted, no content returned
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
        '401':
          description: Authorization error (invalid API key)
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
  /bookings/{tspId}/receipt:
    get:
      operationId: bookingGetReceipt
      summary: Get final booking receipt
      description: >-
        Get finalized pricing and receipt for booking
      tags:
        - Booking
      parameters:
        - name: tspId
          description: ID of the booking created earlier
          in: path
          required: true
          schema:
            $ref: ../schemas/core/booking.json#/definitions/tspId
      responses:
        '200':
          description: The bookings matching the query
          content:
            application/json:
              schema:
                $ref: ../schemas/core/booking.json
        '400':
          description: Bad request (invalid query parameters)
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
        '401':
          description: Authorization error (invalid API key)
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
        '404':
          description: Receipt not ready
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
        default:
          description: unexpected error
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
  /backend/booking/{tspId}:
    patch:
      operationId: backendBookingReceive
      summary: Update booking state
      x-state: review
      description: >-
        Updates booking information at the WhimApp backend. 

        Called by TSP whenever the state of the booking are updated.
      parameters:
        - name: tspId
          description: ID of the booking created earlier
          in: path
          required: true
          schema:
            $ref: ../schemas/core/booking.json#/definitions/tspId
      tags:
        - WebHook
      requestBody:
        content:
          application/json:
            schema:
              $ref: ../schemas/tsp/booking-read-by-id/response.json
            examples:
              Taxi:
                summary: Taxi
                externalValue: '../examples/taxi/booking-read-by-id-response-activated.json'
        description: >-
          Booking information with updated state.
        required: true
      responses:
        '204':
          x-summary: Acknowledged
          description: >-
            Received, no state.
        '400':
          description: Bad request (data failed validation)
          content:
            application/json:
              schema:
                $ref: ../schemas/core/error.json
